# animelocker_mymp4
ANIME LOCKERでスマホ等にコピーするのにいい感じのファイル名のMP4リンクをSMBフォルダに作る

ANIME LOCKERのSMB/DLNAの階層構造とファイル名規則が気に入らないので、自分用にフィルタ／リネームしたフォルダ「99-お好み」を生成するPHPスクリプト。シンボリックリンクを張るだけなので、実態としてのファイル容量はほぼ無視できるレベルです。

##動作ルール
かなり個人的なルールです。適宜改変してご利用ください。
-「01-全録画」フォルダの全ファイルを対象
-キーワード録画のものを除外
-先頭の4桁-4桁の日時部分をカット
-末尾の_HD_[数字]部分もカット
-サブタイトルを「」で囲む
-話数が1桁の時に0パディングして2桁にする
* 加工前：1109-0135_夏目友人帳 伍_6_音無しの谷_HD_383044.MP4
* 加工後：夏目友人帳 伍_06「音無しの谷」.MP4

このルールのファイル名で「99-お好み」フォルダにシンボリックリンクを張ります。
Samba（Windowsファイル共有）やDLNAで目的のファイルが見つけやすくなります。

##設置方法
SFTPなりを使って、ドキュメントルート（/home/foltia/php）下に適当なフォルダを作りindex.phpを保存します。
σ(^^)は、/home/foltia/php/local/mymp4/という感じでフォルダを掘りました。

次に、シェルでログインして、/home/foltia/php/DLNAroot下にフォルダを作成します。
~~~
mkdir /home/foltia/php/DLNAroot/99-お好み
~~~
とか。

##使用法
ブラウザからアクセスします。上記パスに置いた例だと、
~~~
http://(ANIME LOCKERのIPアドレス)/local/mymp4/index.php
~~~
になります。

基本的には当月のフォルダからファイルを探してきます。フォーム部分でその他の月を指定することもできます。
既に同名のシンボリックリンクがある場合はスルーされ、グレーで表示されます。黒字の分が新規に作成したものです。これでSambaのJp-file-style共有->99-お好みフォルダにアクセスすればMP4ファイルが見えるはずです。
いまんとこ作成する一方です。数が増えすぎた時はシェルでザクっと削除しましょう。シンボリックリンクなので消しても元ファイルには影響ありません。

日付指定機能をなくして、cronで定期実行するのもアリだと思いますが、いまんとこ自分でブラウザで直近の追加分を確認してからSambaフォルダを開く方が新規放映分を確認しやすいので、ブラウザ経由で実行する方式にしています。

##簡単なカスタマイズ
ちゃんとテストしてないですが、多分…

###MP4-HDではなく-SDや.tsファイルを取り出したい
50行目辺りにあるMP4-HDをMP4-SDやMPEG2などにします。

###出力フォルダ名（99-お好み）を変更する
62行目辺りの当該部分を変更します。その名前でフォルダを作成するのを忘れずに。
